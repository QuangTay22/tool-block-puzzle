<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Block Blast ‚Äî UI + Solver (Worker)</title>
  <style>
    /* Gi·ªØ nguy√™n to√†n b·ªô CSS nh∆∞ b·∫£n c·ªßa b·∫°n */
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Block Blast ‚Äî UI + Solver</h1>
    <p class="sub">Solver ch·∫°y trong Web Worker. Khi h√†ng/c·ªôt ƒë·∫ßy s·∫Ω chuy·ªÉn sang m√†u v√†ng üü® r·ªìi bi·∫øn m·∫•t ·ªü l∆∞·ª£t ti·∫øp theo.</p>

    <div class="row cols-2">
      <div class="card">
        <div class="section-title">B√†n 8√ó8</div>
        <div id="grid8" class="grid8"></div>
        <div class="bar">
          <button class="btn" id="solveBtn">Solve</button>
          <button class="btn" id="fastSolveBtn">Solve nhanh</button>
          <button class="btn-ghost" id="stepBtn">Step-by-step</button>
          <button class="btn-ghost" id="clearGrid">Clear grid</button>
          <button class="btn-danger" id="resetAll">Reset t·∫•t c·∫£</button>
        </div>
        <div class="legend">
          <span><span class="dot d-grid"></span>√î ƒë√£ c√≥ g·∫°ch</span>
          <span><span class="dot d-empty"></span>√î tr·ªëng</span>
          <span><span class="dot d-piece1"></span>Figure 1</span>
          <span><span class="dot d-piece2"></span>Figure 2</span>
          <span><span class="dot d-piece3"></span>Figure 3</span>
          <span><span class="dot" style="background:#facc15"></span>Cleared (v√†ng)</span>
        </div>
      </div>

      <div class="card">
        <div class="section-title">3 kh·ªëi 5√ó5</div>
        <!-- gi·ªØ nguy√™n fig1, fig2, fig3 + preset nh∆∞ code tr∆∞·ªõc -->
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="section-title">K·∫øt qu·∫£</div>
      <div id="status" class="status">Ch∆∞a ch·∫°y.</div>
    </div>
  </div>

  <script>
    // buildGrid, toggleCell, applyPreset ... gi·ªØ nguy√™n nh∆∞ code c≈© c·ªßa b·∫°n

    // worker
    const worker = new Worker("solver-worker.js")

    function sendToWorker(type){
      const board = readBoard()
      const shapes = [ readFigure(fig1), readFigure(fig2), readFigure(fig3) ]
      const allowRot = document.getElementById('allowRot').checked
      document.getElementById('status').innerText = 'ƒêang t√≠nh...'
      const t0 = performance.now()
      worker.postMessage({ type, board, shapes, allowRot, t0 })
    }

    worker.onmessage = (ev)=>{
      const { type, res, t0, t1 } = ev.data
      if(!res){ document.getElementById('status').innerText = 'Kh√¥ng t√¨m ƒë∆∞·ª£c ph∆∞∆°ng √°n.'; return }
      if(type==="solve"){
        document.getElementById('status').innerHTML = 
          `T·ªïng d√≤ng/cols xo√°: <b>${res.totalCleared||0}</b> ‚Ä¢ Th·ªùi gian: <b>${(t1-t0).toFixed(1)}ms</b>`
        drawToMainBoard(res.steps||[])
        setTimeout(()=> removeClearedVisual(), 1600)
      }
      if(type==="fastSolve"){
        document.getElementById('status').innerHTML = 
          `[Nhanh] T·ªïng xo√°: <b>${res.totalCleared||0}</b> ‚Ä¢ ${(t1-t0).toFixed(1)}ms`
        drawToMainBoard(res.steps||[])
        setTimeout(()=> removeClearedVisual(), 1600)
      }
      if(type==="stepSolve"){
        // gi·ªëng stepBtn c≈© ‚Üí ph√°t t·ª´ng b∆∞·ªõc
        async function play(){
          clearMainVisual()
          for(let i=0;i<(res.steps?.length||0);i++){
            const s = res.steps[i]
            s.shape.forEach(([x,y])=>{
              const gx=s.ox+x, gy=s.oy+y
              grid8[gy*8+gx].classList.add('on','piece'+s.shapeId)
            })
            if(s.fullRows) s.fullRows.forEach(r=>{ for(let c=0;c<8;c++) grid8[r*8+c].classList.add('cleared') })
            if(s.fullCols) s.fullCols.forEach(col=>{ for(let r=0;r<8;r++) grid8[r*8+col].classList.add('cleared') })
            await new Promise(r=>setTimeout(r,550))
          }
          setTimeout(()=> removeClearedVisual(), 900)
          document.getElementById('status').innerText = `Ph√°t xong ‚Äî t·ªïng xo√°: ${res.totalCleared||0}`
        }
        play()
      }
    }

    // n√∫t b·∫•m
    document.getElementById('solveBtn').onclick = ()=> sendToWorker("solve")
    document.getElementById('fastSolveBtn').onclick = ()=> sendToWorker("fastSolve")
    document.getElementById('stepBtn').onclick = ()=> sendToWorker("stepSolve")
  </script>
</body>
</html>
